<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AirForShare — Real-time text & file share</title>
  <style>
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;margin:18px;background:#f7fafc;color:#0f172a}
    .container{max-width:980px;margin:0 auto;background:white;padding:18px;border-radius:10px;box-shadow:0 6px 18px rgba(2,6,23,.08)}
    h1{margin:0 0 10px}
    .row{display:flex;gap:12px}
    .col{flex:1}
    label{display:block;margin:8px 0 6px;font-weight:600}
    textarea{width:100%;min-height:120px;padding:8px;border-radius:6px;border:1px solid #e2e8f0}
    input[type="text"], input[type="file"], input[type="number"]{width:100%;padding:8px;border-radius:6px;border:1px solid #e2e8f0}
    button{padding:8px 12px;border-radius:8px;border:0;background:#0ea5a4;color:white;font-weight:600;cursor:pointer}
    .muted{color:#6b7280;font-size:13px}
    .card{padding:12px;border-radius:8px;border:1px solid #e6eef0;margin-top:12px}
    .list{margin-top:12px}
    .file-row{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px dashed #eef2f7}
    .code-box{display:inline-block;padding:8px 10px;border-radius:6px;background:#0f172a;color:white;font-family:monospace}
    .small{font-size:13px;color:#475569}
  </style>
</head>
<body> net::ERR_INTERNET_DISCONNECTED
e.ea @ webchannel_blob_es2018.js:57
(anonymous) @ webchannel_connection.ts:175
Jo @ webchannel_connection.ts:83
Go @ rest_connection.ts:113
Ho @ rest_connection.ts:165
(anonymous) @ datastore.ts:150
Promise.then
Ho @ datastore.ts:146
__PRIVATE_invokeBatchGetDocumentsRpc @ datastore.ts:217
lookup @ transaction.ts:74
get @ transaction.ts:96
get @ transaction.ts:70
(anonymous) @ index.html:174
(anonymous) @ field_value_impl.ts:32
Hu @ transaction_runner.ts:86
(anonymous) @ transaction_runner.ts:64
(anonymous) @ backoff.ts:145
(anonymous) @ async_queue.ts:200
(anonymous) @ async_queue_impl.ts:138
(anonymous) @ async_queue_impl.ts:192
Promise.then
cc @ async_queue_impl.ts:189
enqueue @ async_queue_impl.ts:136
enqueueAndForget @ async_queue_impl.ts:97
handleDelayElapsed @ async_queue.ts:194
(anonymous) @ async_queue.ts:168
setTimeout
start @ async_queue.ts:160
createAndSchedule @ async_queue.ts:160
enqueueAfterDelay @ async_queue_impl.ts:231
p_ @ backoff.ts:136
Ju @ transaction_runner.ts:59
(anonymous) @ transaction_runner.ts:111
(anonymous) @ async_queue_impl.ts:138
(anonymous) @ async_queue_impl.ts:192
Promise.then
cc @ async_queue_impl.ts:189
enqueue @ async_queue_impl.ts:136
enqueueAndForget @ async_queue_impl.ts:97
Yu @ transaction_runner.ts:108
(anonymous) @ transaction_runner.ts:84
Promise.catch
(anonymous) @ transaction_runner.ts:84
(anonymous) @ backoff.ts:145
(anonymous) @ async_queue.ts:200
(anonymous) @ async_queue_impl.ts:138
(anonymous) @ async_queue_impl.ts:192
Promise.then
cc @ async_queue_impl.ts:189
enqueue @ async_queue_impl.ts:136
enqueueAndForget @ async_queue_impl.ts:97
handleDelayElapsed @ async_queue.ts:194
(anonymous) @ async_queue.ts:168
setTimeout
start @ async_queue.ts:160
createAndSchedule @ async_queue.ts:160
enqueueAfterDelay @ async_queue_impl.ts:231
p_ @ backoff.ts:136
Ju @ transaction_runner.ts:59
ju @ transaction_runner.ts:59
(anonymous) @ transaction.ts:114
await in (anonymous)
(anonymous) @ async_queue_impl.ts:138
(anonymous) @ async_queue_impl.ts:192
Promise.then
cc @ async_queue_impl.ts:189
enqueue @ async_queue_impl.ts:136
enqueueAndForget @ async_queue_impl.ts:97
__PRIVATE_firestoreClientTransaction @ firestore_client.ts:605
runTransaction @ transaction.ts:118
(anonymous) @ index.html:173
(anonymous) @ index.html:190
await in (anonymous)
(anonymous) @ index.html:190
await in (anonymous)
(anonymous) @ index.html:190
await in (anonymous)
(anonymous) @ index.html:190
await in (anonymous)
(anonymous) @ index.html:190
await in (anonymous)
(anonymous) @ index.html:190
await in (anonymous)
(anonymous) @ index.html:190
await in (anonymous)
(anonymous) @ index.html:190
await in (anonymous)
(anonymous) @ index.html:190
await in (anonymous)
(anonymous) @ index.html:190
await in (anonymous)
(anonymous) @ index.html:190
await in (anonymous)
(anonymous) @ index.html:190
await in (anonymous)
(anonymous) @ index.html:190
await in (anonymous)
(anonymous) @ index.html:190
await in (anonymous)
(anonymous) @ index.html:190
await in (anonymous)
(anonymous) @ index.html:190
await in (anonymous)
(anonymous) @ index.html:190
await in (anonymous)
(anonymous) @ index.html:190
await in (anonymous)
(anonymous) @ index.html:190
await in (anonymous)
(anonymous) @ index.html:190
await in (anonymous)
(anonymous) @ index.html:190
await in (anonymous)
(anonymous) @ index.html:190
await in (anonymous)
(anonymous) @ index.html:190
await in (anonymous)
(anonymous) @ index.html:190Understand this error
logger.ts:123 [2025-12-11T18:19:03.174Z]  @firebase/firestore: Firestore (12.6.0): RestConnection RPC 'BatchGetDocuments' 0x6ad04e2d failed with error:  {"code":"unavailable","name":"FirebaseError"} url:  https://firestore.googleapis.com/v1/projects/airforshare-ffcee/databases/(default)/documents:batchGet request: {"documents":["projects/airforshare-ffcee/databases/(default)/documents/shares/8XUY0O"]}
defaultLogHandler @ logger.ts:123
warn @ logger.ts:209
__PRIVATE_logWarn @ log.ts:76
(anonymous) @ rest_connection.ts:119
Promise.then
Go @ rest_connection.ts:113
Ho @ rest_connection.ts:165
(anonymous) @ datastore.ts:150
Promise.then
Ho @ datastore.ts:146
__PRIVATE_invokeBatchGetDocumentsRpc @ datastore.ts:217
lookup @ transaction.ts:74
get @ transaction.ts:96
get @ transaction.ts:70
(anonymous) @ index.html:174
(anonymous) @ field_value_impl.ts:32
Hu @ transaction_runner.ts:86
(anonymous) @ transaction_runner.ts:64
(anonymous) @ backoff.ts:145
(anonymous) @ async_queue.ts:200
(anonymous) @ async_queue_impl.ts:138
(anonymous) @ async_queue_impl.ts:192
Promise.then
cc @ async_queue_impl.ts:189
enqueue @ async_queue_impl.ts:136
enqueueAndForget @ async_queue_impl.ts:97
handleDelayElapsed @ async_queue.ts:194
(anonymous) @ async_queue.ts:168
setTimeout
start @ async_queue.ts:160
createAndSchedule @ async_queue.ts:160
enqueueAfterDelay @ async_queue_impl.ts:231
p_ @ backoff.ts:136
Ju @ transaction_runner.ts:59
(anonymous) @ transaction_runner.ts:111
(anonymous) @ async_queue_impl.ts:138
(anonymous) @ async_queue_impl.ts:192
Promise.then
cc @ async_queue_impl.ts:189
enqueue @ async_queue_impl.ts:136
enqueueAndForget @ async_queue_impl.ts:97
Yu @ transaction_runner.ts:108
(anonymous) @ transaction_runner.ts:84
Promise.catch
(anonymous) @ transaction_runner.ts:84
(anonymous) @ backoff.ts:145
(anonymous) @ async_queue.ts:200
(anonymous) @ async_queue_impl.ts:138
(anonymous) @ async_queue_impl.ts:192
Promise.then
cc @ async_queue_impl.ts:189
enqueue @ async_queue_impl.ts:136
enqueueAndForget @ async_queue_impl.ts:97
handleDelayElapsed @ async_queue.ts:194
(anonymous) @ async_queue.ts:168
setTimeout
start @ async_queue.ts:160
createAndSchedule @ async_queue.ts:160
enqueueAfterDelay @ async_queue_impl.ts:231
p_ @ backoff.ts:136
Ju @ transaction_runner.ts:59
(anonymous) @ transaction_runner.ts:111
(anonymous) @ async_queue_impl.ts:138
(anonymous) @ async_queue_impl.ts:192
Promise.then
cc @ async_queue_impl.ts:189
enqueue @ async_queue_impl.ts:136
enqueueAndForget @ async_queue_impl.ts:97
Yu @ transaction_runner.ts:108
(anonymous) @ transaction_runner.ts:84
Promise.catch
(anonymous) @ transaction_runner.ts:84
(anonymous) @ backoff.ts:145
(anonymous) @ async_queue.ts:200
(anonymous) @ async_queue_impl.ts:138
(anonymous) @ async_queue_impl.ts:192
Promise.then
cc @ async_queue_impl.ts:189
enqueue @ async_queue_impl.ts:136
enqueueAndForget @ async_queue_impl.ts:97
handleDelayElapsed @ async_queue.ts:194
(anonymous) @ async_queue.ts:168
setTimeout
start @ async_queue.ts:160
createAndSchedule @ async_queue.ts:160
enqueueAfterDelay @ async_queue_impl.ts:231
p_ @ backoff.ts:136
Ju @ transaction_runner.ts:59
ju @ transaction_runner.ts:59
(anonymous) @ transaction.ts:114
await in (anonymous)
(anonymous) @ async_queue_impl.ts:138
(anonymous) @ async_queue_impl.ts:192
Promise.then
cc @ async_queue_impl.ts:189
enqueue @ async_queue_impl.ts:136
enqueueAndForget @ async_queue_impl.ts:97
__PRIVATE_firestoreClientTransaction @ firestore_client.ts:605
runTransaction @ transaction.ts:118
(anonymous) @ index.html:173
(anonymous) @ index.html:190
await in (anonymous)
(anonymous) @ index.html:190
await in (anonymous)
(anonymous) @ index.html:190
await in (anonymous)
(anonymous) @ index.html:190
await in (anonymous)
(anonymous) @ index.html:190
await in (anonymous)
(anonymous) @ index.html:190Understand this warning
webchannel_connection.ts:175  POST https://firestore.googleapis.com/v1/projects/airforshare-ffcee/databases/(default)/documents:batchGet net::ERR_INTERNET_DISCONNECTED
e.ea @ webchannel_blob_es2018.js:57
(anonymous) @ webchannel_connection.ts:175
Jo @ webchannel_connection.ts:83
Go @ rest_connection.ts:113
Ho @ rest_connection.ts:165
(anonymous) @ datastore.ts:150
Promise.then
Ho @ datastore.ts:146
__PRIVATE_invokeBatchGetDocumentsRpc @ datastore.ts:217
lookup @ transaction.ts:74
get @ transaction.ts:96
get @ transaction.ts:70
(anonymous) @ index.html:174
(anonymous) @ field_value_impl.ts:32
Hu @ transaction_runner.ts:86
(anonymous) @ transaction_runner.ts:64
(anonymous) @ backoff.ts:145
(anonymous) @ async_queue.ts:200
(anonymous) @ async_queue_impl.ts:138
(anonymous) @ async_queue_impl.ts:192
Promise.then
cc @ async_queue_impl.ts:189
enqueue @ async_queue_impl.ts:136
enqueueAndForget @ async_queue_impl.ts:97
handleDelayElapsed @ async_queue.ts:194
(anonymous) @ async_queue.ts:168
setTimeout
start @ async_queue.ts:160
createAndSchedule @ async_queue.ts:160
enqueueAfterDelay @ async_queue_impl.ts:231
p_ @ backoff.ts:136
Ju @ transaction_runner.ts:59
(anonymous) @ transaction_runner.ts:111
(anonymous) @ async_queue_impl.ts:138
(anonymous) @ async_queue_impl.ts:192
Promise.then
cc @ async_queue_impl.ts:189
enqueue @ async_queue_impl.ts:136
enqueueAndForget @ async_queue_impl.ts:97
Yu @ transaction_runner.ts:108
(anonymous) @ transaction_runner.ts:84
Promise.catch
(anonymous) @ transaction_runner.ts:84
(anonymous) @ backoff.ts:145
(anonymous) @ async_queue.ts:200
(anonymous) @ async_queue_impl.ts:138
(anonymous) @ async_queue_impl.ts:192
Promise.then
cc @ async_queue_impl.ts:189
enqueue @ async_queue_impl.ts:136
enqueueAndForget @ async_queue_impl.ts:97
handleDelayElapsed @ async_queue.ts:194
(anonymous) @ async_queue.ts:168
setTimeout
start @ async_queue.ts:160
createAndSchedule @ async_queue.ts:160
enqueueAfterDelay @ async_queue_impl.ts:231
p_ @ backoff.ts:136
Ju @ transaction_runner.ts:59
(anonymous) @ transaction_runner.ts:111
(anonymous) @ async_queue_impl.ts:138
(anonymous) @ async_queue_impl.ts:192
Promise.then
cc @ async_queue_impl.ts:189
enqueue @ async_queue_impl.ts:136
enqueueAndForget @ async_queue_impl.ts:97
Yu @ transaction_runner.ts:108
(anonymous) @ transaction_runner.ts:84
Promise.catch
(anonymous) @ transaction_runner.ts:84
(anonymous) @ backoff.ts:145
(anonymous) @ async_queue.ts:200
(anonymous) @ async_queue_impl.ts:138
(anonymous) @ async_queue_impl.ts:192
Promise.then
cc @ async_queue_impl.ts:189
enqueue @ async_queue_impl.ts:136
enqueueAndForget @ async_queue_impl.ts:97
handleDelayElapsed @ async_queue.ts:194
(anonymous) @ async_queue.ts:168
setTimeout
start @ async_queue.ts:160
createAndSchedule @ async_queue.ts:160
enqueueAfterDelay @ async_queue_impl.ts:231
p_ @ backoff.ts:136
Ju @ transaction_runner.ts:59
ju @ transaction_runner.ts:59
(anonymous) @ transaction.ts:114
await in (anonymous)
(anonymous) @ async_queue_impl.ts:138
(anonymous) @ async_queue_impl.ts:192
Promise.then
cc @ async_queue_impl.ts:189
enqueue @ async_queue_impl.ts:136
enqueueAndForget @ async_queue_impl.ts:97
__PRIVATE_firestoreClientTransaction @ firestore_client.ts:605
runTransaction @ transaction.ts:118
(anonymous) @ index.html:173
(anonymous) @ index.html:190
await in (anonymous)
(anonymous) @ index.html:190
await in (anonymous)
(anonymous) @ index.html:190
await in (anonymous)
(anonymous) @ index.html:190
await in (anonymous)
(anonymous) @ index.html:190
await in (anonymous)
(anonymous) @ index.html:190Understand this error
logger.ts:123 [2025-12-11T18:19:03.223Z]  @firebase/firestore: Firestore (12.6.0): RestConnection RPC 'BatchGetDocuments' 0x6ad04e2f failed with error:  {"code":"unavailable","name":"FirebaseError"} url:  https://firestore.googleapis.com/v1/projects/airforshare-ffcee/databases/(default)/documents:batchGet request: {"documents":["projects/airforshare-ffcee/databases/(default)/documents/shares/oNili4"]}
defaultLogHandler @ logger.ts:123
warn @ logger.ts:209
__PRIVATE_logWarn @ log.ts:76
(anonymous) @ rest_connection.ts:119
Promise.then
Go @ rest_connection.ts:113
Ho @ rest_connection.ts:165
(anonymous) @ datastore.ts:150
Promise.then
Ho @ datastore.ts:146
__PRIVATE_invokeBatchGetDocumentsRpc @ datastore.ts:217
lookup @ transaction.ts:74
get @ transaction.ts:96
get @ transaction.ts:70
(anonymous) @ index.html:174
(anonymous) @ field_value_impl.ts:32
Hu @ transaction_runner.ts:86
(anonymous) @ transaction_runner.ts:64
(anonymous) @ backoff.ts:145
(anonymous) @ async_queue.ts:200
(anonymous) @ async_queue_impl.ts:138
(anonymous) @ async_queue_impl.ts:192
Promise.then
cc @ async_queue_impl.ts:189
enqueue @ async_queue_impl.ts:136
enqueueAndForget @ async_queue_impl.ts:97
handleDelayElapsed @ async_queue.ts:194
(anonymous) @ async_queue.ts:168
setTimeout
start @ async_queue.ts:160
createAndSchedule @ async_queue.ts:160
enqueueAfterDelay @ async_queue_impl.ts:231
p_ @ backoff.ts:136
Ju @ transaction_runner.ts:59
(anonymous) @ transaction_runner.ts:111
(anonymous) @ async_queue_impl.ts:138
(anonymous) @ async_queue_impl.ts:192
Promise.then
cc @ async_queue_impl.ts:189
enqueue @ async_queue_impl.ts:136
enqueueAndForget @ async_queue_impl.ts:97
Yu @ transaction_runner.ts:108
(anonymous) @ transaction_runner.ts:84
Promise.catch
(anonymous) @ transaction_runner.ts:84
(anonymous) @ backoff.ts:145
(anonymous) @ async_queue.ts:200
(anonymous) @ async_queue_impl.ts:138
(anonymous) @ async_queue_impl.ts:192
Promise.then
cc @ async_queue_impl.ts:189
enqueue @ async_queue_impl.ts:136
enqueueAndForget @ async_queue_impl.ts:97
handleDelayElapsed @ async_queue.ts:194
(anonymous) @ async_queue.ts:168
setTimeout
start @ async_queue.ts:160
createAndSchedule @ async_queue.ts:160
enqueueAfterDelay @ async_queue_impl.ts:231
p_ @ backoff.ts:136
Ju @ transaction_runner.ts:59
(anonymous) @ transaction_runner.ts:111
(anonymous) @ async_queue_impl.ts:138
(anonymous) @ async_queue_impl.ts:192
Promise.then
cc @ async_queue_impl.ts:189
enqueue @ async_queue_impl.ts:136
enqueueAndForget @ async_queue_impl.ts:97
Yu @ transaction_runner.ts:108
(anonymous) @ transaction_runner.ts:84
Promise.catch
(anonymous) @ transaction_runner.ts:84
(anonymous) @ backoff.ts:145
(anonymous) @ async_queue.ts:200
(anonymous) @ async_queue_impl.ts:138
(anonymous) @ async_queue_impl.ts:192
Promise.then
cc @ async_queue_impl.ts:189
enqueue @ async_queue_impl.ts:136
enqueueAndForget @ async_queue_impl.ts:97
handleDelayElapsed @ async_queue.ts:194
(anonymous) @ async_queue.ts:168
setTimeout
start @ async_queue.ts:160
createAndSchedule @ async_queue.ts:160
enqueueAfterDelay @ async_queue_impl.ts:231
p_ @ backoff.ts:136
Ju @ transaction_runner.ts:59
ju @ transaction_runner.ts:59
(anonymous) @ transaction.ts:114
await in (anonymous)
(anonymous) @ async_queue_impl.ts:138
(anonymous) @ async_queue_impl.ts:192
Promise.then
cc @ async_queue_impl.ts:189
enqueue @ async_queue_impl.ts:136
enqueueAndForget @ async_queue_impl.ts:97
__PRIVATE_firestoreClientTransaction @ firestore_client.ts:605
runTransaction @ transaction.ts:118
(anonymous) @ index.html:173
(anonymous) @ index.html:190
await in (anonymous)
(anonymous) @ index.html:190
await in (anonymous)
(anonymous) @ index.html:190
await in (anonymous)
(anonymous) @ index.html:190
await in (anonymous)
(anonymous) @ index.html:190
await in (anonymous)
(anonymous) @ index.html:190
await in (anonymous)
(anonymous) @ index.html:190
await in (anonymous)
(anonymous) @ index.html:190
await in (anonymous)
(anonymous) @ index.html:190
await in (anonymous)
(anonymous) @ index.html:190
await in (anonymous)
(anonymous) @ index.html:190
await in (anonymous)
(anonymous) @ index.html:190
await in (anonymous)
(anonymous) @ index.html:190
await in (anonymous)
(anonymous) @ index.html:190
await in (anonymous)
(anonymous) @ index.html:190
await in (anonymous)
(anonymous) @ index.html:190
await in (anonymous)
(anonymous) @ index.html:190
await in (anonymous)
(anonymous) @ index.html:190
await in (anonymous)
(anonymous) @ index.html:190Understand this warning
webchannel_connection.ts:175  POST https://firestore.googleapis.com/v1/projects/airforshare-ffcee/databases/(default)/documents:batchGet net::ERR_INTERNET_DISCONNECTED
  <div class="container">
    <h1>AirForShare — Share text & files (real-time)</h1>
    <p class="muted">Paste your Firebase config into the JS placeholder, then use this page to create & access shares by code. Multiple users can use same tool simultaneously.</p>

    <div class="card">
      <h3>Create a new share</h3>
      <label>Title</label>
      <input id="shareTitle" type="text" placeholder="Optional title (e.g., 'Project files')" />

      <label>Text (paste or type)</label>
      <textarea id="shareText" placeholder="Type text or paste content to share..."></textarea>

      <label>Files (you can choose multiple)</label>
      <input id="shareFiles" type="file" multiple />

      <div style="display:flex;gap:8px;margin-top:8px;align-items:center">
        <button id="createBtn">Save & Share</button>
        <button id="clearBtn" style="background:#ef4444">Clear All</button>
        <div class="muted small">Default expiry: 24 hours</div>
      </div>

      <div id="createdBox" class="card" style="display:none;margin-top:12px">
        <div><strong>Share code:</strong> <span id="generatedCode" class="code-box"></span>
          <button id="copyCodeBtn" style="margin-left:10px">Copy</button>
        </div>
        <div class="small" style="margin-top:8px">Share this code with someone to let them view/download the text & files in real-time.</div>
        <div style="margin-top:8px"><button id="openViewerBtn">Open viewer for this code</button></div>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <h3>Open a share (enter code)</h3>
      <div style="display:flex;gap:8px;align-items:center">
        <input id="openCodeInput" type="text" placeholder="Enter share code (e.g., Ab1XyZ)" />
        <button id="openBtn">Open</button>
        <button id="clearViewerBtn" style="background:#ef4444">Clear Viewer</button>
      </div>

      <div id="viewer" class="card" style="display:none">
        <h4 id="viewerTitle">Share</h4>
        <div class="small">Share code: <span id="viewerCode" class="code-box"></span></div>
        <div style="margin-top:8px">
          <strong>Text (live):</strong>
          <div id="liveText" style="white-space:pre-wrap;padding:8px;border-radius:6px;border:1px solid #eef2f7;background:#fbfdff;margin-top:6px;min-height:80px"></div>
        </div>

        <div style="margin-top:8px">
          <strong>Files:</strong>
          <div id="filesList" class="list"></div>
        </div>

        <div style="margin-top:8px">
          <strong>Send a quick text update:</strong>
          <div style="display:flex;gap:8px;margin-top:6px">
            <input id="quickText" type="text" placeholder="Type a short message to append/update" />
            <button id="sendQuickText">Send</button>
          </div>
        </div>

        <div style="margin-top:8px" id="viewerMeta" class="muted small"></div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK (v12 modular) -->
  <script type="module">
    // ----------------- PASTE YOUR FIREBASE CONFIG HERE -----------------
    // Replace the following object with your Firebase config from console
    const firebaseConfig = {
      apiKey: "AIzaSyDH0E6mkfkEUh76nv__2fOk-HJteZCj-hE",
    authDomain: "airforshare-ffcee.firebaseapp.com",
    projectId: "airforshare-ffcee",
    storageBucket: "airforshare-ffcee.firebasestorage.app",
    messagingSenderId: "1086862252600",
    appId: "1:1086862252600:web:d0aad96edea3ab6f27e4cd"
    };
    // ------------------------------------------------------------------

    // Minimal validation
    if (!firebaseConfig || !firebaseConfig.projectId) {
      console.warn("Firebase config missing — paste your firebaseConfig object in the code.");
    }

    // Firebase imports (modular)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getFirestore, collection, doc, setDoc, getDoc, addDoc, serverTimestamp, onSnapshot, updateDoc, arrayUnion, writeBatch, runTransaction, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
    import { getStorage, ref as storageRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-storage.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

    // init
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const auth = getAuth(app);

    // Sign in anonymously for simple usage (optional)
    signInAnonymously(auth).catch((e)=>console.warn("Anon sign-in failed:", e));
    onAuthStateChanged(auth, user => {
      if (user) console.log("Signed in as", user.uid);
    });

    // DOM refs
    const createBtn = document.getElementById("createBtn");
    const shareTitle = document.getElementById("shareTitle");
    const shareText = document.getElementById("shareText");
    const shareFiles = document.getElementById("shareFiles");
    const createdBox = document.getElementById("createdBox");
    const generatedCodeEl = document.getElementById("generatedCode");
    const copyCodeBtn = document.getElementById("copyCodeBtn");
    const openViewerBtn = document.getElementById("openViewerBtn");
    const clearBtn = document.getElementById("clearBtn");
    const clearViewerBtn = document.getElementById("clearViewerBtn");

    const openCodeInput = document.getElementById("openCodeInput");
    const openBtn = document.getElementById("openBtn");
    const viewer = document.getElementById("viewer");
    const viewerCode = document.getElementById("viewerCode");
    const viewerTitle = document.getElementById("viewerTitle");
    const liveText = document.getElementById("liveText");
    const filesList = document.getElementById("filesList");
    const quickText = document.getElementById("quickText");
    const sendQuickText = document.getElementById("sendQuickText");
    const viewerMeta = document.getElementById("viewerMeta");

    // Utility: generate short base62 code (6 chars)
    const CHARS = "0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ";
    function genCode(len=6){
      let s="";
      for(let i=0;i<len;i++) s+=CHARS[Math.floor(Math.random()*CHARS.length)];
      return s;
    }

    // Create a share document with generated code
    createBtn.addEventListener("click", async () => {
      const title = shareTitle.value.trim() || "Untitled";
      const text = shareText.value || "";
      const files = shareFiles.files;
      const code = genCode(6);

      // default expiry 24 hours from now (optional)
      const expiresAt = new Date(Date.now() + 24*60*60*1000);

      // prepare share doc
      const shareDocRef = doc(db, "shares", code);

      // create doc in transaction to avoid collisions (rare)
      try {
        await runTransaction(db, async (tx) => {
          const snap = await tx.get(shareDocRef);
          if (snap.exists()) throw "collision";
          tx.set(shareDocRef, {
            code,
            title,
            ownerUid: auth.currentUser ? auth.currentUser.uid : null,
            createdAt: serverTimestamp(),
            expiresAt: expiresAt,
            latestText: text,
            viewers: [],
            filesCount: 0
          });
        });
      } catch (e) {
        console.warn("Collision creating code, retrying...", e);
        // on collision, simply retry (very unlikely)
        return createBtn.click();
      }

      // upload files if any
      if (files && files.length > 0) {
        const uploadPromises = [];
        for (const f of files) {
          uploadPromises.push(uploadFileForShare(code, f));
        }
        await Promise.all(uploadPromises);
        // update filesCount
        const shareRef = doc(db, "shares", code);
        await updateDoc(shareRef, { filesCount: files.length });
      }

      // show created UI
      generatedCodeEl.textContent = code;
      createdBox.style.display = "block";
      createdBox.scrollIntoView({behavior:"smooth"});
    });

    async function uploadFileForShare(code, file){
      const fileDocRef = doc(collection(db, "shares", code, "files")); // auto id
      const path = `shares/${code}/${Date.now()}_${file.name}`;
      const sRef = storageRef(storage, path);
      // upload bytes with resumable so larger files ok
      const uploadTask = uploadBytesResumable(sRef, file);
      return new Promise((resolve, reject) => {
        uploadTask.on('state_changed', (snapshot)=>{
          // could show progress if desired
        }, (err)=>{
          console.error("Upload failed", err);
          reject(err);
        }, async ()=>{
          // success
          const url = await getDownloadURL(sRef);
          await setDoc(fileDocRef, {
            filename: file.name,
            storagePath: path,
            downloadURL: url,
            size: file.size,
            contentType: file.type || null,
            uploadedAt: serverTimestamp(),
            uploader: auth.currentUser ? auth.currentUser.uid : null
          });
          resolve();
        });
      });
    }

    // Clear all data function
    function clearAllData() {
      shareTitle.value = "";
      shareText.value = "";
      shareFiles.value = "";
      createdBox.style.display = "none";
      generatedCodeEl.textContent = "";
    }

    function clearViewer() {
      viewer.style.display = "none";
      openCodeInput.value = "";
      quickText.value = "";
      liveText.textContent = "";
      filesList.innerHTML = "";
      viewerMeta.textContent = "";
      if (currentUnsubscribe) currentUnsubscribe();
      if (currentFilesUnsub) currentFilesUnsub();
    }

    // Clear buttons
    clearBtn.addEventListener("click", clearAllData);
    clearViewerBtn.addEventListener("click", clearViewer);

    // Copy code button
    copyCodeBtn.addEventListener("click", () => {
      const code = generatedCodeEl.textContent;
      if (!code) return;
      navigator.clipboard.writeText(code).then(()=> alert("Code copied to clipboard"));
    });

    // Open viewer for the created code
    openViewerBtn.addEventListener("click", () => {
      const code = generatedCodeEl.textContent;
      if (!code) return alert("No code created");
      openCodeInput.value = code;
      openBtn.click();
    });

    // Open share by code
    let currentUnsubscribe = null;
    let currentFilesUnsub = null;
    openBtn.addEventListener("click", async () => {
      const code = openCodeInput.value.trim();
      if (!code) return alert("Enter a code");
      // detach previous listeners
      if (currentUnsubscribe) currentUnsubscribe();
      if (currentFilesUnsub) currentFilesUnsub();

      const shareRef = doc(db, "shares", code);
      // get once and then subscribe for realtime
      const snap = await getDoc(shareRef);
      if (!snap.exists()) return alert("Share not found or expired");
      viewer.style.display = "block";
      viewerCode.textContent = code;
      viewerTitle.textContent = snap.data().title || "Share";

      // realtime listener for share doc (updates to latestText, metadata)
      currentUnsubscribe = onSnapshot(shareRef, docSnap => {
        if (!docSnap.exists()){
          alert("Share removed or expired");
          viewer.style.display = "none";
          return;
        }
        const d = docSnap.data();
        liveText.textContent = d.latestText || "";
        const createdAt = d.createdAt ? new Date(d.createdAt.seconds*1000).toLocaleString() : "unknown";
        const expires = d.expiresAt ? new Date(d.expiresAt.seconds*1000).toLocaleString() : "none";
        viewerMeta.textContent = `Created: ${createdAt} • Expires: ${expires} • Files: ${d.filesCount || 0}`;
      });

      // realtime listener for files subcollection
      const filesCol = collection(db, "shares", code, "files");
      // simple polling: listen to recent files
      currentFilesUnsub = onSnapshot(filesCol, (qSnap) => {
        filesList.innerHTML = "";
        qSnap.forEach(docFile => {
          const f = docFile.data();
          const el = document.createElement("div");
          el.className = "file-row";
          el.innerHTML = `<div><strong>${escapeHtml(f.filename)}</strong> <div class="muted small">${(f.size/1024).toFixed(1)} KB • uploaded</div></div>
            <div>
              <button data-url="${f.downloadURL}" class="downloadBtn">Download</button>
            </div>`;
          filesList.appendChild(el);
        });
        // attach download listeners
        document.querySelectorAll(".downloadBtn").forEach(b=>{
          b.onclick = () => {
            const url = b.dataset.url;
            window.open(url, "_blank");
          };
        });
      });
    });

    // Enter key support for inputs
    quickText.addEventListener("keypress", (e) => {
      if (e.key === "Enter") sendQuickText.click();
    });
    
    openCodeInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") openBtn.click();
    });

    // Quick text send: append an "edit" entry and update latestText
    sendQuickText.addEventListener("click", async () => {
      const code = viewerCode.textContent;
      if (!code) return alert("Open a share first");
      const val = quickText.value.trim();
      if (!val) return;
      const editsCol = collection(db, "shares", code, "edits");
      const shareRef = doc(db, "shares", code);

      // create an edit doc and also update latestText in transaction
      try {
        await runTransaction(db, async (tx) => {
          const sSnap = await tx.get(shareRef);
          if (!sSnap.exists()) throw "Share missing";
          // create edit
          const newEditRef = doc(editsCol); // auto id
          tx.set(newEditRef, {
            text: val,
            createdAt: serverTimestamp(),
            author: auth.currentUser ? auth.currentUser.uid : null
          });
          // update latestText by appending
          const prev = sSnap.data().latestText || "";
          const combined = prev ? prev + "\n" + val : val;
          tx.update(shareRef, { latestText: combined });
        });
        quickText.value = "";
      } catch (e) {
        console.error("Failed to send quick text", e);
        alert("Failed to send update");
      }
    });

    // Helper: escape HTML for safe insertion
    function escapeHtml(str){
      if(!str) return "";
      return str.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;");
    }

    // Simple cleanup note: expired shares are not auto-deleted by this client.
    // You can add a Cloud Function to periodically delete expired share docs and storage files.

    // OPTIONAL: If you want P2P (WebRTC) direct transfer when both peers are on same network,
    // we can add a signaling channel using Firestore (e.g., collection 'webrtc_signals/{code}').
    // That reduces storage usage and speeds up LAN transfers. Tell me if you want that and I'll add.
  </script>
</body>
</html>
